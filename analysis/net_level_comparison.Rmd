---
title: "Comparison species and individual based networks"
author: "Elena Quintero"
date: "`r Sys.Date()`"
output: html_document
---

```{r include = F}
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```


```{r, message=F}
library(here)
library(tidyverse)
library(magrittr)
library(ggfortify)
library(bipartite)
library(igraph)
library(tnet)
library(patchwork)

theme_set(theme_minimal())
```

Load observed net-level metrics:

```{r}
net.level <- read.csv(here("data/net.level.selection.csv")) %>%
  mutate(type = recode(type, "ind"="ind-based", "sp"="sp-based"))

#glimpse(net.level)
```


Load null model derived net-level metrics:

```{r}
nulls <- read_rds(here("data/net_level_nulls.rds"))
```

Select only metrics of interest:

```{r}
metrics.of.interest <- c("connectance", 
                         "weighted.NODF", 
                         "M", 
                         "interaction.evenness",
                         "centralization.w",
                         "assortativity")
```


Summarize null model metrics:

```{r}
obs.metrics.long <- net.level |> 
  select(net_id, net_n, net_size, type_long = type, all_of(metrics.of.interest)) |> 
  pivot_longer(cols = -c(1:4), names_to = "metric", values_to = "value_obs") |> 
  mutate(type = ifelse(type_long == "ind-based", "ind", "sp"))
#630 observations

null.data.sum <- nulls |> 
  select(type, net_id, iter, all_of(metrics.of.interest)) |> 
  pivot_longer(cols = -c(1:3), names_to = "metric", values_to = "value") |> 
  group_by(type, net_id, metric) |> 
  summarise(mean_nulls = mean(value),
            sd_nulls = sd(value)) |> 
  left_join(obs.metrics.long) |> 
  mutate(z_score = (value_obs - mean_nulls) / sd_nulls,
         diff_nulls = (value_obs - mean_nulls))

```

Convert null to long format:

```{r}
null.metrics.long <- nulls |> 
  select(net_code, net_n, net_size, type, all_of(metrics.of.interest)) |> 
  pivot_longer(cols = -c(1:4), names_to = "metric", values_to = "value")
#630,000 observations
```

Check null-models metrics distribution:

```{r fig.width=10, fig.height=8}
plot.fun <- function(x) {null.metrics.long |>
  filter(metric == {{x}}) |>
  ggplot(aes(x = value, fill = type)) +
  #geom_density(alpha = 0.5) +
  geom_histogram() +
  scale_fill_manual(values = c("grey20", "grey80")) +
  theme(legend.position = "none",
        axis.text.y = element_blank()) +
  labs(y = NULL, x = NULL, title =  {{x}}) + 
  facet_wrap(~net_code, scales = "free")}

plot.fun("connectance")
# plot.fun("weighted.NODF")
# plot.fun("interaction.evenness")
# plot.fun("M")
# plot.fun("assortativity")
# plot.fun("centralization.w")

```


```{r fig.width = 10, fig.height = 5}
null.data.sum <- null.data.sum |> 
  mutate(metric = recode(metric, 
                         "M" = "Modularity",
                         "assortativity" = "Assortativity",
                         "centralization.w" = "Centralization",
                         "connectance" = "Connectance",
                         "interaction.evenness" = "Interaction evenness",
                         "weighted.NODF" = "Weighted NODF")) 
  
p1 <- null.data.sum |> 
  ggplot(aes(x = value_obs, fill = type_long)) + 
  geom_density(alpha = 0.5) + 
  facet_wrap(~metric, scales = "free", nrow = 1) + 
  scale_fill_manual(values = c("grey10", "grey80")) +
  #scale_fill_manual(values = c("grey40", "#2F8AC4")) +
  theme(panel.background = element_rect(colour = "black"),
        axis.text.y = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank()) + 
  labs(y = NULL, x = NULL, title = "A. Observed values",
       color = "Netwok n\type", fill = "Network \ntype")

p2 <- null.data.sum |> 
  ggplot(aes(x = diff_nulls, fill = type)) + 
  geom_density(alpha = 0.5) + 
  facet_wrap(~metric, scales = "free", nrow = 1) + 
  scale_fill_manual(values = c("grey10", "grey80")) +
  #scale_fill_manual(values = c("grey40", "#2F8AC4")) +
  theme(legend.position = "none",
        axis.text.y = element_blank(), 
        panel.background = element_rect(colour = "black"), 
        strip.background = element_rect(colour = "white"),
        panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank()) + 
  labs(y = NULL, x = NULL, title = "B. Deviation from null models")

p1 / p2 + plot_layout(guides = "collect")

#ggsave(here("figs/figs_rev1/Fig_2_panels.pdf"), width = 9, height = 7)

```


Summary metrics:

```{r}
sum.tb <- null.data.sum |> 
  group_by(metric, type) |> 
  summarise(obs_mean = round(mean(value_obs), 2),
            obs_sd = round(sd(value_obs), 2),
            nulls_mean = round(mean(mean_nulls), 2),
            nulls_sd = round(mean(sd_nulls), 2),
            nulls_diff = round(mean(diff_nulls), 2),
            nulls_diff_sd = round(sd(diff_nulls), 2),
            nulls_zs = round(mean(z_score), 2)) |> 
  mutate(obs = paste0(obs_mean, " ± ", obs_sd),
         nulls = paste0(nulls_mean, " ± ", nulls_sd),
         diff = paste0(nulls_diff, " ± ", nulls_diff_sd)) |> 
  select(metric, type, obs, nulls, diff)

sum.tb

#write_csv(sum.tb, here("tables/net_metrics_summary.csv"))
```

