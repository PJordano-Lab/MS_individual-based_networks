---
title: "Exploration of node level metrics - manual calculation and selection"
author: "Elena Quintero"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

Libraries:

```{r}
library(here)
library(bipartite)
library(igraph)
library(tidyverse)
library(tidylog)
library(magrittr)
library(reshape2)
library(patchwork)
library(ggpubr)
library(rcartocolor)
library(GGally)
library(reshape2)
```

-----------------

Load all networks metrics:

```{r}
ind.level.df <- read.csv(here("data/node.level.selection.csv"))

glimpse(ind.level.df)
```

Normalization function:

```{r}
min_max_norm <- function(x){(x-min(x))/(max(x)-min(x))}
```

Normalize species strength:

```{r}
ind.level.df %<>% 
  group_by(net_id) %>% 
  mutate(species.strength.norm = min_max_norm(species.strength))
```

Full comparison metrics:

```{r, fig.width=12, fig.height=10}
metrics <- c("normalised.degree",
              #"proportional.generality",
             "species.strength.norm",
             #"interaction.push.pull",
             "species.specificity.index",
             "weighted.closeness",
             #"proportional.similarity",
             #"d",
             "mean.bray.overlap")

#colnames(ind.level.df)

ggpairs(
 ind.level.df, columns = metrics,
 lower = list(continuous = wrap("points", pch = 21, color = "white", fill= "black", size = 0.75))) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```


```{r}
interest.metrics <- ind.level.df %>% ungroup() %>% dplyr::select(all_of(metrics))

source(here("functions/vif_function.R"))

vif_func(in_frame = as.data.frame(interest.metrics), thresh = 3, trace = T)
```


Metrics correlation:

```{r cor_selec_metrics, fig.width = 8, fig.height = 6}
net.level <- read.csv(here("data/net.level.selection.csv"))
n.animals <- net.level %>% 
  dplyr::select(net_id, 
         animals = number.of.species.HL, 
         net_size)

df <- ind.level.df %>%
  ungroup() %>% 
  dplyr::select(net_id, all_of(metrics)) %>%
  group_by(net_id) %>%
  mutate(plants = n()) %>%
  left_join(n.animals) %>%
  rename("Normalised degree" = normalised.degree,
         "Species strength" = species.strength.norm,
         "Species specificity" = species.specificity.index,
         "Weighted closeness" = weighted.closeness,
         "Mean Bray overlap " = mean.bray.overlap,
         "Network size" = net_size)

library(ggcorrplot)
corr_matrix <- cor(df[-c(1,7,8)])
p.mat <- cor_pmat(df[-c(1,7,8)])

ggcorrplot(corr_matrix, type = "lower", show.diag = F,
           hc.order = F, lab = T)

#ggsave(here("figs/cor_node_metrics.pdf"), width = 6, height = 6)
```


## Node metrics distibution:

```{r}
#Net colors:
mycols <- as.character(ind.level.df$cols_continent3)
names(mycols) <- as.character(ind.level.df$plant_sp)
theme_set(theme_bw())
```


# Plot metrics distribution by net

```{r}
plot_density_metric <- function(metric){
    plot <- ggplot(ind.level.df, aes(x = {{metric}}, color = plant_sp)) + 
        geom_density(bw = 0.1) +
        scale_color_manual(values = mycols) + 
        theme(legend.position = "none") + 
        scale_x_continuous(limits = c(0,1)) +
        labs(y = NULL)
  
    plot
}

plot_density_metric(normalised.degree)

#facet wrap by net:
#plot_density_metric(normalised.degree) + facet_wrap(~fct_reorder(net_name, plant_plot_rank))
```


```{r}
p1 <- plot_density_metric(normalised.degree) + labs(x = "Normalised degree")
p2 <- plot_density_metric(species.strength.norm) + labs(x = "Species strength")
p3 <- plot_density_metric(species.specificity.index) + labs(x = "Species specificity index")
p4 <- plot_density_metric(weighted.closeness) + labs(x = "Weighted closeness")
p5 <- plot_density_metric(mean.bray.overlap) + labs(x = "Mean Bray overlap")

(p1 + p3 + p4) / (p2 + p5) #+ plot_layout(labs(y = NULL))

design <- "
123
456
"  

(p1 + p2 + p3 + p5 + p4) + plot_layout(design = design)

#ggsave(here("figs/node_metrics_distribution.pdf"), width = 8, height = 6)
```

