---
title: "PCA_plants_individuals"
author: "Elena Quintero"
date: "`r Sys.Date()`"
output: github_document
---


```{r, message=F}
library(here)
library(tidyverse)
library(tidylog)
library(psych)
library(ggfortify)
library(ggnewscale)
library(patchwork)
theme_set(theme_minimal())
```

## DATA

Load metrics from posteriors data:

```{r}
files <- list.files(here("data/net_metrics_posteriors/"))

#select only those files with node metrics (not net metrics)
files_nodes <- files[grep("node", files)]

df.metrics <- data.frame()

for (i in 1:length(files_nodes)) {
  
  df <- readRDS(here(paste0("data/net_metrics_posteriors/", files_nodes[i]))) |> 
    dplyr::select(-c(node,Fisher.alpha)) |> 
    mutate(net_ind = paste0(net_id, "-", ind))
  
  df.metrics <- rbind(df.metrics, df)
  
}
```

Select metrics for PCA

```{r}
metrics.pca <- c("normalised.degree", 
                 "species.strength",
                 "species.specificity.index",
                 "weighted.closeness",
                 "mean.bray.overlap")
```

## PCA analisys

Perform PCA with 1000 posteriors (i.e. 1000 scenarios)

```{r}
pca.list <- list()

for (i in 1:1000) {
  
  scenario <- df.metrics[, c("iter", metrics.pca)] |> 
    filter(iter == i) |> 
    dplyr::select(-iter)
  
  pc_ind <- prcomp(scenario,
              center = TRUE,
              scale. = TRUE)
  
  pca.list[[i]] <- pc_ind
  
}
```

### Load data:

```{r}
recat.cluster.df <- readRDS(here("data/results_cluster_analysis.rds"))
```

Load net info:

```{r}
info <- read.csv(here("data/net.level.selection.csv")) |> 
  filter(type == "ind") |> 
  select(net_id, net_n, net_code, code_ID, ref, 
         family, plant_sp, bioregion, continent,
         plot_rank1, plot_rank2, 
         number.of.species.HL, number.of.species.LL)
```

Load net colors:

```{r}
net_cols <- read_csv(here("data/net_colors.csv"))

col.bio <- as.character(net_cols$cols_bioregions2)
names(col.bio) <- as.character(net_cols$plant_sp)

col.bio.d <- as.character(net_cols$cols_bioregions_d2)
names(col.bio.d) <- as.character(net_cols$bioregion)
```

Perform a single PCA with all posteriors:

```{r}
full.pca.df <- df.metrics[, c("iter", metrics.pca)] |> 
    dplyr::select(-iter)
  
full.pca <- prcomp(full.pca.df,
              center = TRUE,
              scale. = TRUE)
  
summary(full.pca)
print(full.pca)
```

Summarize PCA - medians for point centroids of each individual and extract loadings

```{r}
most_common_group <- recat.cluster.df |> 
  group_by(net_id, net_ind) |> 
  summarise(group_assigned_new = names(which.max(table(group_assigned_new))))

pca.full.coords <- full.pca$x |> 
    as.data.frame() |> 
    cbind(df.metrics) |> 
    left_join(info) |> 
    left_join(most_common_group)

pca.full.loadings <- full.pca$rotation |> 
  as.data.frame() |> 
  rownames_to_column("loading")

pca.median <- pca.full.coords |> 
  group_by(net_id, plant_sp, net_ind, group_assigned_new) |> 
  summarise(PC1_median = median(PC1),
            PC2_median = median(PC2))

net.cluster.summary <- recat.cluster.df |> 
  left_join(info) |> 
  group_by(plant_sp, plot_rank2, net_id, net_n, iter, group_assigned_new) |> 
  summarise(n = n()) |> 
  group_by(net_n, iter) |> 
  mutate(total_inds = sum(n),
         per_inds = n/total_inds)
```


# NUMBERS

Quantify in numbers:

```{r}
# number of times (iters) that a population has at least 1 individual that falls in each category (max = 1000 iters)

net.cluster.summary |> 
  group_by(net_id, group_assigned_new) |> 
  summarise(n = n()) |> 
  pivot_wider(names_from = group_assigned_new, values_from = n)

# number of individuals that mostly fall in each category per population

most_common_group |> 
  group_by(net_id) |> 
  count(group_assigned_new) |> 
  pivot_wider(names_from = group_assigned_new, values_from = n)

# percentage of different profile individuals

net.cluster.summary  |> 
  ungroup() |> 
  select(net_id, iter, per_inds, cluster = group_assigned_new) |>
  mutate(iter = as.character(iter))  |> 
  tidyr::complete(net_id, iter) |> 
  mutate(per_inds = if_else(is.na(per_inds), 0, per_inds)) |> 
  group_by(cluster) |> 
  summarise(mean_per = mean(per_inds),
            ci_per = bayestestR::ci(per_inds, ci = 0.9))

# percentage of "leading" individuals per population

net.cluster.summary  |> 
  ungroup() |> 
  filter(group_assigned_new == "Leading") |>
  select(net_id, iter, per_inds) |>
  mutate(iter = as.character(iter))  |> 
  tidyr::complete(net_id, iter) |> 
  mutate(per_inds = if_else(is.na(per_inds), 0, per_inds)) |> 
  group_by(net_id) |> 
  summarise(mean_per = mean(per_inds),
            ci_per = bayestestR::ci(per_inds, ci = 0.90))



# number of populations with leading individuals

net.cluster.summary  |> 
  ungroup() |> 
  filter(group_assigned_new == "Leading") |>
  select(net_id, iter, per_inds) |>
  mutate(iter = as.character(iter))  |> 
  group_by(iter) |> 
  summarise(n_pops = n_distinct(net_id)) |> 
  ungroup() |> 
  summarise(mean_per = mean(n_pops),
            ci_per = bayestestR::ci(n_pops, ci = 0.90))
```

### PLOTS

Plot proportion of plant individuals assigned to each cluster per net

```{r}
ggplot(net.cluster.summary,
         aes(x = net_id, y = per_inds, 
             color = group_assigned_new)) + 
  ggdist::stat_pointinterval() + 
  rcartocolor::scale_color_carto_d(palette = "Pastel") + 
  theme(axis.text.x = element_text(angle = 90)) + 
  facet_wrap(~group_assigned_new, nrow = 1)

ggplot(net.cluster.summary,
       aes(x = group_assigned_new, y = per_inds, 
           color = group_assigned_new)) +
  ggdist::stat_pointinterval() +
  rcartocolor::scale_color_carto_d(palette = "Pastel") +
  facet_wrap(~net_id, nrow = 5) + 
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "bottom") +
  labs(x = NULL, y = "Percentage of plant individuals",
       color = "Interaction profile")
```


### FIGURE 5

```{r}
p1 <- ggplot(pca.median, aes(x = PC1_median, y = PC2_median, 
             color = plant_sp, shape = group_assigned_new,
             fill = plant_sp)) + 
  geom_segment(data = pca.full.loadings, inherit.aes = FALSE,
               aes(x = 0, y = 0, xend = 5*PC1, yend = 5*PC2), 
               arrow = arrow(length = unit(0.1, "inches")),
               color = "grey30")+ 
  geom_point(size = 2) + 
  #scale_shape_manual(values = c(17, 4, 16, 21)) +
  scale_shape_manual(values = c(21, 4, 24, 25)) +
  scale_color_manual(values = col.bio) +
  scale_fill_manual(values = col.bio) +
  ggrepel::geom_text_repel(data = pca.full.loadings, inherit.aes = FALSE,
               aes(x = 5*PC1, y = 5*PC2, label = loading)) +
  theme(legend.position = "none",
        panel.border = element_rect(color = "grey50", fill = NA)) 

p2 <- ggplot(net.cluster.summary,
             aes(x = fct_reorder(as.character(net_n), plot_rank2), 
                 y = per_inds, fill = plant_sp,
                 color = plant_sp, shape = group_assigned_new)) + 
  ggdist::stat_pointinterval(.width = c(0.85), linewidth = 0.75) + 
  #scale_shape_manual(values = c(17, 4, 16, 21)) +
  scale_shape_manual(values = c(21, 4, 24, 25)) +
  scale_color_manual(values = col.bio) + 
  scale_fill_manual(values = col.bio) + 
  theme(axis.text.x = element_blank(),
        legend.position = "none",
        panel.grid.major.x = element_blank(),
        panel.border = element_rect(color = "grey50", fill = NA) ) + 
  facet_wrap(~group_assigned_new, nrow = 1) + 
  scale_x_discrete(expand = c(.05, .05)) +
  scale_y_continuous(expand = c(.02, .02)) +
  labs(x = "Populations", 
       y = "Percentage of individuals \nbelonging to the cluster")

p1 / p2 + plot_layout(heights = c(6,2))

#ggsave(here("figs/Fig_5_clusters1.pdf"), width = 9, height = 9)
```


```{r}
p3 <- ggplot(pca.median, 
             aes(x = PC1_median, y = PC2_median, 
             color = plant_sp)) + 
  geom_segment(data = pca.full.loadings, inherit.aes = FALSE,
               aes(x = 0, y = 0, xend = 5*PC1, yend = 5*PC2), 
               arrow = arrow(length = unit(0.1, "inches")),
               color = "grey30")+ 
  geom_point(size = 2) + 
  scale_color_manual(values = col.bio) +
  ggrepel::geom_text_repel(data = pca.full.loadings, inherit.aes = FALSE,
               aes(x = 5*PC1, y = 5*PC2, label = loading)) +
  theme(legend.position = "none",
        panel.border = element_rect(color = "grey50", fill = NA)) 

p4 <- ggplot(pca.median, 
             aes(x = PC1_median, y = PC2_median, 
             color = group_assigned_new)) + 
  geom_segment(data = pca.full.loadings, inherit.aes = FALSE,
               aes(x = 0, y = 0, xend = 5*PC1, yend = 5*PC2), 
               arrow = arrow(length = unit(0.1, "inches")),
               color = "grey30")+ 
  geom_point(size = 2) + 
  rcartocolor::scale_color_carto_d(palette = "Pastel") +
  #scale_color_manual(values = cluster.cols) + 
  ggrepel::geom_text_repel(data = pca.full.loadings, inherit.aes = FALSE,
               aes(x = 5*PC1, y = 5*PC2, label = loading)) +
  theme(legend.position = "none",
        panel.border = element_rect(color = "grey50", fill = NA)) 

p5 <- ggplot(net.cluster.summary,
             aes(x = fct_reorder(as.character(net_n), plot_rank2), 
                 y = per_inds, 
             color = group_assigned_new)) + 
  ggdist::stat_pointinterval(fill = "white", .width = c(0.85), linewidth = 0.75) + 
  theme(axis.text.x = element_blank(),
        legend.position = "none",
        panel.grid.major.x = element_blank(),
        panel.border = element_rect(color = "grey50", fill = NA)) + 
  facet_wrap(~group_assigned_new, nrow = 1) + 
  scale_x_discrete(expand = c(.05, .05)) +
  scale_y_continuous(expand = c(.02, .02)) +
  rcartocolor::scale_color_carto_d(palette = "Pastel") +
  #scale_color_manual(values = cluster.cols) + 
  labs(x = "Populations", 
       y = "Percentage of individuals \nbelonging to the cluster")

p3/p4/p5 + plot_layout(heights = c(6,6,2))

ggsave(here("figs/Fig_5_clusters2.pdf"), width = 8, height = 12)
```


```{r}
p6 <- recat.cluster.df |> 
  group_by(net_id) |> 
  mutate(net_n = cur_group_id()) |> 
  group_by(net_n, iter, group_assigned_new) |> 
  summarise(n = n()) |> 
  group_by(iter, net_n) |> 
  mutate(total_inds = sum(n),
         per_inds = n/total_inds) |> 
  ggplot(aes(x = iter, y = per_inds, fill = group_assigned_new)) + 
  geom_bar(stat = "identity") + 
  facet_wrap(~net_n, nrow = 1) + 
  rcartocolor::scale_fill_carto_d(palette = "Pastel") + 
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        panel.grid = element_blank()) + 
  labs(x = "Plant population", 
       y = "Cumulative proportion of individuals \nbelonging to each interaction profile",
       fill = "Interaction profile")

p4/p6 + plot_layout(heights = c(6,2))

#ggsave(here("figs/Fig_S_cluster_assignation1.png"), width = 12, height = 12)
```

```{r}
p7 <- recat.cluster.df |> 
  left_join(info, by = "net_id") |> 
  group_by(bioregion) |> 
  mutate(n_sp = n_distinct(plant_sp),
         n_pop = n_distinct(net_id),
         bioregion = paste0(bioregion, "\n(", n_sp, "sp, ", n_pop, " pop)")) |> 
  group_by(bioregion, iter, group_assigned_new) |> 
  summarise(n = n()) |> 
  group_by(iter, bioregion) |> 
  mutate(total_inds = sum(n),
         per_inds = n/total_inds) |> 
  ggplot(aes(x = iter, y = per_inds, fill = group_assigned_new)) + 
  geom_bar(stat = "identity") + 
  facet_wrap(~bioregion, nrow = 1) + 
  rcartocolor::scale_fill_carto_d(palette = "Pastel") + 
  theme(axis.text.x = element_blank(),
        legend.position = "none",
        panel.grid = element_blank()) + 
  labs(x = NULL,
       y = "Cumulative proportion of individuals belonging to each interaction profile",
       fill = "Interaction profile")


p8 <- recat.cluster.df |> 
  left_join(info, by = "net_id") |> 
  group_by(family) |> 
  mutate(n_sp = n_distinct(plant_sp),
         n_pop = n_distinct(net_id),
         family = paste0(family, "\n(", n_sp, "sp, ", n_pop, " pop)")) |> 
  group_by(family, iter, group_assigned_new) |> 
  summarise(n = n()) |> 
  group_by(iter, family) |> 
  mutate(total_inds = sum(n),
         per_inds = n/total_inds) |> 
  ggplot(aes(x = iter, y = per_inds, fill = group_assigned_new)) + 
  geom_bar(stat = "identity") + 
  facet_wrap(~family, nrow = 4) + 
  rcartocolor::scale_fill_carto_d(palette = "Pastel") + 
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        panel.grid = element_blank()) + 
  labs(x = NULL,
       y = "Cumulative proportion of individuals belonging to each interaction profile",
       fill = "Interaction profile")

p9 <- ggplot(data.frame(l = p7$labels$y, x = 1, y = 1)) +
      geom_text(aes(x, y, label = l), angle = 90) + 
      theme_void() +
      coord_cartesian(clip = "off")

p7$labels$y <- p8$labels$y <- NULL

mylayout <- "
  122222222222
  133333333333
  133333333333
  133333333333
"


p9 + p7 + p8 + plot_layout(design = mylayout)

#ggsave(here("figs/Fig_S_cluster_assignation_regions.png"), width = 8, height = 8)
```
